# Ревью проекта fastapi-personal-dashboard

Обзор по состоянию после добавления расширений Health, Learning, Productivity, Integrations.

---

## 1. Что не хватает (пробелы)

### Backend

- **Forgot password** — сброс пароля по email (в Backlog, но не реализован).
- **Валидация `entry_type`** — в Health допустимы только `day` / `morning` / `evening`; в API можно передать любое значение (нет Enum или проверки по списку).
- **Лимит целей по сфере** — сейчас лимит 5 целей всего; нет отдельного лимита «не более N целей по health» и т.п. (по желанию).
- **Пагинация списков** — `GET /health`, `/finance` и т.д. отдают до 1000 записей; при большом объёме данных нужна пагинация (offset/limit или cursor).
- **Связь SyncJob с DataSource** — у SyncJob нет `data_source_id`; нельзя однозначно показать «последний джоб по этому источнику» без фильтра по provider + user (текущий вариант работает, но при нескольких источниках одного провайдера — неоднозначно).
- **Тесты** — покрыты в основном auth и entries; нет тестов для analytics, goals, integrations, export, reminders, новых полей (entry_type, steps, courses, tasks, focus_sessions).

### Frontend

- **Новые поля не отражены в UI**:
  - **Health**: `entry_type`, `steps`, `heart_rate_avg`, `workout_minutes` не показываются и не редактируются на HealthPage.
  - **Learning**: `course_id`, `source_type` и список курсов (CRUD курсов) не используются.
  - **Productivity**: `focus_category`, задачи (tasks), сессии фокуса (sessions) не используются.
- **Типы в `entries.ts`** — `HealthEntry`, `ProductivityEntry`, `LearningEntry` не содержат новых полей (entry_type, steps, completed_task_ids, focus_category, course_id, source_type и т.д.).
- **API клиент**:
  - Нет вызовов: `/learning/streak`, `/learning/courses`, `/reminders`, `/export/health-report`, `/analytics/productivity-dashboard`, `/integrations/sources/:id/status`, `/integrations/google_fit/oauth-url`, `/integrations/google_fit/oauth-callback`, `/integrations/apple-health/import`.
  - `DataSource` в типах не содержит `last_error`, `sync_settings`, `user_id`.
- **Интеграции на фронте**:
  - Нет OAuth-флоу для Google Fit (редирект по oauth-url, callback с code).
  - Нет загрузки файла для Apple Health.
  - Нет отображения last_error и кнопки «Обновить сейчас» с учётом статуса/ошибки.
  - Нет настройки sync_settings (какие метрики подмешивать).
- **Локализация** — в `en.json` / `ru.json` могут отсутствовать ключи для новых сущностей (курсы, задачи, сессии, напоминания, экспорт отчёта и т.д.).
- **Зависимости** — в `frontend-react/package.json` нет `i18next`, `react-i18next`, `i18next-browser-languagedetector`, хотя они используются в коде; либо они подтягиваются откуда-то ещё — стоит явно добавить в dependencies.

---

## 2. Что добавить (функционал)

### Приоритет высокий

1. **Фронт для новых полей**
   - Health: выбор entry_type (day/morning/evening), поля steps, heart_rate_avg, workout_minutes (опционально).
   - Learning: выбор курса из списка (GET /learning/courses), source_type (book/course/podcast); страница или секция «Мои курсы» с CRUD.
   - Productivity: focus_category (code/writing/meetings), список задач с дедлайнами и статусами, кнопка «Добавить сессию» (Pomodoro) с длительностью и типом.

2. **Интеграции в UI**
   - Кнопка «Подключить через Google» → переход по oauth-url → после редиректа с code — POST oauth-callback, обновление списка источников.
   - Загрузка файла Apple Health (export.xml или .zip) с отображением результата (импортировано записей/дней).
   - Для каждого источника: статус синка, last_error, кнопка «Обновить сейчас» (POST .../sync), опционально настройка sync_settings (чекбоксы метрик).

3. **Напоминания**
   - При заходе на дашборд вызывать GET /reminders; если есть напоминание «заполни здоровье за вчера» — показывать баннер или модал с кнопкой «Заполнить» (переход на /health с датой «вчера»).

4. **Экспорт отчёта по здоровью**
   - На странице Health или в общем экспорте: «Отчёт для врача» — выбор периода, кнопка скачивания CSV (GET /export/health-report?start_date=&end_date=).

5. **Дашборд продуктивности**
   - Отдельная страница или блок на дашборде: вызов GET /analytics/productivity-dashboard, отображение best/worst weekday, трендов, top_hours, focus_by_category, инсайта.

### Приоритет средний

6. **Learning streak** — на странице Learning или дашборде: вызов GET /learning/streak, отображение «серия дней подряд» и last_activity_date.
7. **Привязка задач к записи продуктивности** — при создании/редактировании записи за день: мультиселект «Выполненные задачи» (completed_task_ids), подтягивание списка из GET /productivity/tasks (open/done).
8. **Цели по новым метрикам** — в настройках целей для сферы health: выбор target_metric = steps, workout_minutes (уже есть в backend).
9. **Фоновый sync** — перенос run_sync в BackgroundTasks, чтобы POST .../sync сразу возвращал job, а синк шёл в фоне; на фронте — опрос GET /sync-jobs или GET source status до завершения.

### Приоритет низкий

10. **PDF-экспорт** — генерация PDF-отчёта по здоровью (библиотека reportlab/weasyprint на backend или jsPDF на фронте).
11. **Календарь занятий (Learning)** — вид «календарь» по дням с study_hours и темами.
12. **Pomodoro-таймер** — страница или виджет с таймером и кнопкой «Завершить сессию» с отправкой POST /productivity/sessions.

---

## 3. Что улучшить (код и архитектура)

### Backend

- **Валидация** — для entry_type, source_type, focus_category, session_type использовать Enum или Literal в Pydantic и по необходимости в БД (CHECK или enum type).
- **Разделение слоёв** — вынести маппинг «Fitness API → HealthEntry» и «Apple XML → HealthEntry» в отдельные функции/сервисы, чтобы routes оставались тонкими.
- **Ошибки** — в интеграциях при падении fetch логировать traceback и при необходимости сохранять усечённый message в last_error (уже частично есть).
- **Rate limit** — кроме «не чаще раз в N секунд», можно добавить общий rate limit по IP/пользователю (например, через slowapi или middleware).
- **Конфиг** — вынести константы (GOOGLE_OAUTH_AUTH_URL, FITNESS_AGGREGATE_URL, размер макс. файла импорта) в config или constants.

### Frontend

- **Типы** — синхронизировать типы в `entries.ts`, `integrations.ts`, `analytics.ts`, `goals.ts` с актуальными API-ответами (включая новые поля и вложенные объекты).
- **Обработка ошибок** — единообразно обрабатывать 4xx/5xx и сообщения валидации (например, через axios interceptor и вывод в тост или баннер).
- **Загрузка состояний** — скелетоны уже есть в CSS; использовать их на всех страницах при isLoading (например, в Dashboard, Goals, Integrations).
- **Доступность (a11y)** — проверить aria-label у кнопок, навигацию с клавиатуры, контраст; по возможности добавить роль и подписи к графикам.

### Инфраструктура

- **CI** — в тестах добавить прогон с миграциями (alembic upgrade head) и хотя бы smoke-тесты основных эндпоинтов (health, goals, analytics).
- **Pre-commit** — убедиться, что ruff/black и линтеры фронта работают по всем изменённым файлам.

---

## 4. Расширение функционала 

- **Виджеты дашборда** — дать пользователю включать/выключать блоки (тренды, цели, графики по сферам) и сохранять раскладку в профиле или localStorage.
- **Уведомления** — push или email «не заполнял N дней» / «напоминание: здоровье за вчера» (нужен бэкенд-воркер или внешний сервис).
- **Темная тема** — переключатель темы, CSS-переменные для цветов, сохранение в localStorage.
- **Мобильная версия** — улучшить верстку и тапы под мобильные; при необходимости PWA (manifest, service worker) для «добавить на главный экран».
- **Экспорт в Google Sheets / Notion** — опционально экспорт выбранных метрик по расписанию (интеграции).
- **Цели «закончить курс»** — target_metric = course_complete, привязка к course_id; прогресс = доля занятий/модулей или ручная отметка «завершён».
- **Категории расходов** — справочник категорий и маппинг транзакций Open Banking в свои категории (уже есть задел в open_banking.py).

---

## 5. UI/UX — как сделать интерфейс привлекательнее

### Визуал

- **Шрифты** — оставить Inter как базовый; для заголовков можно подключить один акцентный шрифт (например, Plus Jakarta Sans или Manrope) через Google Fonts.
- **Цвета** — задать палитру через CSS-переменные (--color-primary, --color-success, --color-surface и т.д.), чтобы потом легко менять тему; добавить лёгкие градиенты для карточек или hero (как на лендинге).
- **Карточки и тени** — чуть более «мягкие» тени (например, 0 4px 20px rgba(0,0,0,0.06)) и скругление 12–16px уже есть; для акцентов — тонкая цветная полоска слева у карточки (по сфере: здоровье — зелёный, финансы — синий и т.д.).
- **Графики** — в Recharts задать цвета линий/баров из палитры; подписи осей и тултипы на выбранном языке (i18n); при пустом состоянии — не пустой график, а иллюстрация или текст «Добавьте данные за период».

### Навигация и структура

- **Группировка пунктов меню** — «Аналитика» (Dashboard, Weekly report, Productivity dashboard), «Данные» (Health, Finance, Productivity, Learning), «Цели и интеграции» (Goals, Integrations), «Настройки» (Settings, Billing).
- **Хлебные крошки** — на вложенных страницах (например, Настройки → Цели) показывать путь для возврата.
- **Пустые состояния** — на каждой странице записей: иллюстрация/иконка + короткий текст + одна кнопка «Добавить первую запись» (как в empty-state уже есть по стилю).

### Микро-взаимодействия

- **Кнопки** — лёгкий hover (scale 1.02 или смена яркости), для «Обновить сейчас» — спиннер на время запроса.
- **Формы** — фокус у полей с подсветкой (ring) в цвет primary; после успешного сабмита — краткий success toast (уже есть).
- **Таблицы** — при наведении на строку — подсветка строки; кнопки редактирования/удаления показывать по hover или всегда в виде иконок.

### Контент

- **Подсказки** — для полей вроде entry_type, focus_category, source_type — короткий tooltip или подпись под полем («Утро / день / вечер»).
- **Даты** — везде форматировать даты через Intl или dayjs/date-fns с учётом локали (уже частично в Weekly report).
- **Числа** — единицы измерения там, где нужно (часы, кг, шаги и т.д.); при желании — краткие подписи под метриками на дашборде («в среднем за месяц»).

---

## 6. Чек-лист по приоритетам

### Быстрые победы (1–2 дня)

- [ ] Добавить в `frontend-react/package.json` зависимости: `i18next`, `react-i18next`, `i18next-browser-languagedetector` (если их нет при установке).
- [ ] Расширить типы в `entries.ts` и `integrations.ts` под новые поля и эндпоинты.
- [ ] HealthPage: поля entry_type, steps, heart_rate_avg, workout_minutes (опционально).
- [ ] IntegrationsPage: показ last_error, кнопка «Обновить сейчас» с вызовом sync и отображением статуса/ошибки.
- [ ] Вызов GET /reminders на дашборде и показ баннера «Заполни здоровье за вчера» при need.

### Средний объём (неделя)

- [ ] Learning: страница/секция курсов (CRUD), выбор курса и source_type в форме записи; вызов GET /learning/streak и отображение streak.
- [ ] Productivity: форма с focus_category; страница/блок задач (CRUD); форма «Сессия фокуса»; при редактировании записи — выбор completed_task_ids.
- [ ] Google Fit OAuth на фронте: кнопка «Подключить через Google» → редирект → callback с code → обновление списка источников.
- [ ] Apple Health: загрузка файла (input file) и вызов POST /integrations/apple-health/import.
- [ ] Экспорт: кнопка «Отчёт для врача» с выбором периода и скачиванием health-report CSV.
- [ ] Страница или блок «Дашборд продуктивности» с данными GET /analytics/productivity-dashboard.

### Долгосрочно

- [ ] Forgot password (email + ссылка).
- [ ] Темная тема, виджеты дашборда, уведомления.
- [ ] Расширить тесты (backend и e2e по критичным сценариям).

---

*Документ можно дополнять по мере реализации пунктов и сдвига приоритетов.*
